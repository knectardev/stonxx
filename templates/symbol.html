<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ symbol }} • Stock Details</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        h1 { font-size: 22px; font-weight: 600; }
        .back-link {
            color: #4a9eff; text-decoration: none; padding: 6px 10px;
            border: 1px solid #2a2a2a; border-radius: 4px; background: #141414;
        }
        .card {
            background-color: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 8px;
        }
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .meta { color: #b0b0b0; font-size: 12px; }
        .loading { text-align: center; padding: 40px; color: #b0b0b0; }
        .error { background-color: #3a1a1a; color: #ff6b6b; padding: 12px; margin: 12px 20px; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; }
        thead { background-color: #2a2a2a; }
        th, td { padding: 12px 16px; border-bottom: 1px solid #2a2a2a; }
        th { color: #b0b0b0; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .price-cell { color: #4ecdc4; font-weight: 500; }
        tbody tr:hover { background-color: #252525; }
        .summary { color: #b0b0b0; font-size: 12px; }
        /* Chart styles */
        .chart-container {
            width: 100%;
            height: 520px;
            padding: 16px 20px;
        }
        .chart-inner {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ symbol }} • Historical Price Data (1-Minute Bars)</h1>
            <a class="back-link" href="/">← Back to list</a>
        </div>
        <div id="info" class="meta" style="margin-bottom: 10px;"></div>

        <div class="card">
            <div class="card-header">
                <div class="summary" id="summaryText">Loading...</div>
            </div>
            <div id="detailBody">
                <div class="loading">Loading historical data...</div>
            </div>
        </div>
    </div>

    <!-- Lightweight Charts (TradingView) -->
    <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        const SYMBOL = "{{ symbol }}";

        function renderPriceChart(data) {
            const container = document.getElementById('detailBody');
            if (!data.bars || data.bars.length === 0) {
                container.innerHTML = '<div class="loading">No historical data available for this symbol.</div>';
                return;
            }

            // Info
            if (data.date_range) {
                const startDate = new Date(data.date_range.start);
                const endDate = new Date(data.date_range.end);
                const days = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24));
                document.getElementById('info').textContent =
                    `Data range: ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()} (${days} days)`;
                document.getElementById('summaryText').textContent =
                    `Total bars: ${data.count.toLocaleString()} (showing all)`;
            } else {
                document.getElementById('summaryText').textContent =
                    `Total bars: ${data.count.toLocaleString()} (showing all)`;
            }

            // Build chart container
            container.innerHTML = '<div class="chart-container"><div id="chartRoot" class="chart-inner"></div></div>';
            const chartRoot = document.getElementById('chartRoot');

            // Prepare series data
            const candles = [];
            const volumes = [];
            for (const bar of data.bars) {
                const t = Math.floor(new Date(bar.datetime).getTime() / 1000);
                candles.push({ time: t, open: bar.open, high: bar.high, low: bar.low, close: bar.close });
                const up = bar.close >= bar.open;
                volumes.push({ time: t, value: bar.volume, color: up ? 'rgba(38,166,154,0.5)' : 'rgba(239,83,80,0.5)' });
            }

            // Create chart
            const chart = LightweightCharts.createChart(chartRoot, {
                width: chartRoot.clientWidth,
                height: chartRoot.clientHeight,
                layout: {
                    background: { color: '#1a1a1a' },
                    textColor: '#e0e0e0',
                },
                grid: {
                    vertLines: { color: '#2a2a2a' },
                    horzLines: { color: '#2a2a2a' },
                },
                rightPriceScale: { borderColor: '#2a2a2a' },
                timeScale: { borderColor: '#2a2a2a' },
                crosshair: { mode: 1 },
            });

            const candleSeries = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
                borderUpColor: '#26a69a',
                borderDownColor: '#ef5350',
            });
            candleSeries.setData(candles);

            const volumeSeries = chart.addHistogramSeries({
                priceFormat: { type: 'volume' },
                priceScaleId: '',
                scaleMargins: { top: 0.8, bottom: 0 },
            });
            volumeSeries.setData(volumes);

            // Resize handling
            function resizeChart() {
                chart.applyOptions({ width: chartRoot.clientWidth, height: chartRoot.clientHeight });
            }
            window.addEventListener('resize', resizeChart);
            if ('ResizeObserver' in window) {
                const ro = new ResizeObserver(() => resizeChart());
                ro.observe(chartRoot);
            }

            chart.timeScale().fitContent();
        }

        function showError(message) {
            const container = document.getElementById('detailBody');
            container.innerHTML = `<div class="error">Error: ${message}</div>`;
        }

        window.addEventListener('DOMContentLoaded', () => {
            fetch(`/api/bars/${encodeURIComponent(SYMBOL)}?timeframe=1Min`)
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    renderPriceChart(data);
                })
                .catch(err => showError(err.message));
        });
    </script>
</body>
</html>


